***The included source code, service and information is provided as is, and OmniUpdate makes no promises or guarantees about its use or misuse. The source code provided is recommended for advanced users and may not be compatible with all implementations of OU Campus.***

# Blog Notes

## Preface
This implementation utilizes the Foundation framework, so each script is tailored to output a specific HTML, keep this in mind when implementing. Happy Blogging.

## Outline
A blog consists of three main parts, listing pages/assets, post files, and scripts. The blog listing page is a PCF which OU Campus outputs as an HTML page with function calls to external scripts, based on page parameters. See [Blog Listing Template](#listing) below for specific page params.  OU Campus holds each post as a PCF, XSL outputs two types of files, content (HTML) and data (XML). This data is taken upon page creation (post.tcf) and manually input via page properties and multi-edit.
Scripts are XSL and PHP (ASP to come.. maybe). XSL handles the XML output and to a lesser extent the HTML - it's mostly just boring content. Blog Assets are handled with a template-match, see [Assets](#assets) for more detail. PHP does the grunt work by crawling a given directory structure for XML post files, displaying content, and for pagination.

## Structure
This is only a suggested structure, change it to suit your implementation.
* PCF
	* /blog/listing.pcf
	* /blog/post/1-lorem-ipsum.pcf
* XSL
	* /\_resources/xsl/blog/blog-functions.xsl
	* /\_resources/xsl/blog/listing.xsl
	* /\_resources/xsl/blog/post-xml.xsl
	* /\_resources/xsl/blog/post.xsl
* PHP
	* /\_resources/php/blog/blog-funstions.php
	* /\_resources/php/blog/listing.php
	* /\_resources/php/blog/rss.php
* CSS
	* /\_resources/css/blog/blog.css

### Templates

* Blog sections
	* Creates necessary resource files (nav, _prop) and a post directory.
	* You may want to impose template groups.
* Listing page
	* You may want more than the blog/index.pcf as a listing page, eg. a listing for each year.
* Post page

### PCF options

* <a name="listing">Listing page parameters</a>
	* "Display Featured" choose to display "featured post" slide show.
	* "Feature Limit" how many posts to display in slider.
	* "Year Filter" default is empty - all years.
	* "Posts per page" limits the number of posts shown before pagination.
	* "Tag Filter Strength" can be either 'strict' (posts must have all tags on the listing page) 
		or 'loose' (posts must have at least one of the tags on the listing page) filtering
	* "Search Root" this param denotes where to begin the directory tree search for posts

* Post page
	* Parameters
		* "Enable Disqus Comments", default is off.
	* Multi-Edit (stores post data)
		* TCF Variables: title, description, author, date (auto generated by OU $CurrentDate), email, featured post option.
		* PCF Properties: disqus (comments) toggle, date ("datetime" picker).
		* PCF Multi-Edit (not passed by TCF): display toggle and image.

* Tags
	* Tags are managed via OU Campus tag management and thus added via Page Properties. 
		* Add tags to a listing page to filter blog posts by specific tags.

### Post Comments

Are powered by a _Disqus asset_. This asset should contain a unique "disqus_shortname" given when setup at https://disqus.com/.

	<div id="disqus_thread"></div>
		<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'your-forum-shortname'; // required: replace example with your forum shortname

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function() {
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

Posts have the option to activate comments via properties, this is (most likely/ should be) an asset located in the XSL or an editable region of the PCF.  
The Listing page should also contain disqus code to enable a count of comments for each post listed. Example:

	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'your-forum-shortname'; // required: replace example with your forum shortname

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function () {
			var s = document.createElement('script'); s.async = true;
			s.type = 'text/javascript';
			s.src = '//' + disqus_shortname + '.disqus.com/count.js';
			(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
		}());
	</script>

###<a name="assets">Assets</a>
Are meant to compliment the main listing of blog posts, with list of tags/categories, or recent posts, etc. They can be dropped on to any blog page and function. If you want these assets to function outside of "post" and "listing" pages you must include the PHP scripts. Just make sure to include the scripts before you call the function, probably in the `<head>` node.

    <xsl:if test="$ou:action = 'pub' and /document[descendant::blog]">
		<xsl:processing-instruction name="php">
			require_once($_SERVER["DOCUMENT_ROOT"] . "/_resources/php/blog/listing.php");
		?</xsl:processing-instruction>
    </xsl:if>

Each asset is a single blog node with attributes defining it's output: __type__, __dir__, __year__, __tags__, __filtering__ and __limit__. Example:

    <blog type="page-related" dir="/" filtering="strict" limit="3"/>

##### Attributes
*REQUIRED*
* __Dir__ tells the PHP scripts where to begin looking for _(XML)_ post files.  
* __Type__ tells the XSL how to structure and filter the blog listing.  
* __Limit__ is the number of items to display, zero means there is no limit - display all items, default is 3.  

*OPTIONAL*
* __tags__ (for type="tag-related") enter tag filters as CSV, eg. tags="consetetur, dolor sit amet"
* __filtering__ (for type="tag-related" or type="page-related")
    * "loose" (default value) - posts with one or more tags from this page are included in listing.
    * "strict" - posts must have ALL tags on this page to be included in listing. included.
* __year__ for adding a year filter to the asset listing

A template match converts this node as help text, for staging, and a PHP statement for production. Posts are output in a basic *teaser* format with a title, link, and possible image. Tag listing is output in a simple `<ul><li>` structure. 

__Types available__: (all gather posts from defined _dir_, with respect to _limit_)

1. "available-tags" - creates a list of tags used in blog post files.
2. "popular-tags" - creates a list of most frequently used tags.
3. "recent" - posts by pubDate.
4. "featured" - posts marked as _featured_.
5. "page-related" - posts that have the same tags as the page the asset is on.
6. "tag-related" - posts that have specific tags.
	- using this type requires that an additional 'tags' attribute be used to specify what tags to look for.
	- eg. tags="consetetur, dolor sit amet" - (csv separated)

Example: you want to display the most recent page-related (a post that shares the same tags) from the academics blog:

    <blog type"page-related" dir="/academics/blog/" limit="3" filtering="loose"/>

Outputs:

    <div class="spost clearfix">
		<div class="entry-image">
			<a href="#link" target="_blank" class="nobg"><img src="#imagesrc" alt="#imagealt"></a>
		</div>
		<div class="entry-c">
			<div class="entry-title">
				<h4><a href="#link" target="_blank">Blog Post Title</a></h4>
			</div>
			<ul class="entry-meta">
				<li><i class="icon-calendar3"></i>Publish Date</li>
			</ul>
		</div>
	</div>
	<div class="spost clearfix">
		<div class="entry-image">
			<a href="#link" target="_blank" class="nobg"><img src="#imagesrc" alt="#imagealt"></a>
		</div>
		<div class="entry-c">
			<div class="entry-title">
				<h4><a href="#link" target="_blank">Blog Post Title</a></h4>
			</div>
			<ul class="entry-meta">
				<li><i class="icon-calendar3"></i>Publish Date</li>
			</ul>
		</div>
	</div>
	<div class="spost clearfix">
		<div class="entry-image">
			<a href="#link" target="_blank" class="nobg"><img src="#imagesrc" alt="#imagealt"></a>
		</div>
		<div class="entry-c">
			<div class="entry-title">
				<h4><a href="#link" target="_blank">Blog Post Title</a></h4>
			</div>
			<ul class="entry-meta">
				<li><i class="icon-calendar3"></i>Publish Date</li>
			</ul>
		</div>
	</div>

Example: you want to display the 5 most popular tags from the blog as links:

    <blog type="popular-tags" dir="/blog/" limit="5"/>

Outputs: 

    <ul class="tag-list">
        <li class="link-bullets"><a href='/blog/?tags=campus+life'>campus life</a></li>
        <li class="link-bullets"><a href='/blog/?tags=alumni'>alumni</a></li>
        <li class="link-bullets"><a href='/blog/?tags=athletics'>athletics</a></li>
        <li class="link-bullets"><a href='/blog/?tags=general'>general</a></li>
        <li class="link-bullets"><a href='/blog/?tags=scholarship'>scholarship</a></li>
        <li class="link-bullets"><a href='/blog/?tags=housing'>housing</a></li>
    </ul>

New asset as of 4/14/17 - blog-archive

example: <blog-archive path="/_blog-dev/index.html" month="10" year="2016"/>

##### Attributes
* path - the path to the general listing page to use for filtering - usually the all news listing page at blog root.
* month - the start month to begin creating archive links (1-12)
* year - the start year to begin listing archive links by month.

## Scripts
Each post PCF is processed by XSL to output only the essential data as XML. PHP scripts output different lists of posts, featured, recent, related, etc.

###XSL

#### pubDate = dateTime
To prep the date variable "pubDate" an XSL function _(ou:toDateTime)_ converts the date given by the OU property _type="datetime"_ to a valid XSL dateTime object. This allows us to use XSL functions for dateTimes, namely _format-dateTime()_.

Note: post.tmpl uses the OU System Variable $CurrentDate to output "Friday, January 30, 2015 3:17:33 PM PST". However accessing and saving via parameters converts this date format to "01/30/2015 03:17:33 PM". _(ou:toDateTime)_ accounts for both formats.

Once we have a dateTime object we use _ou:pubDate()_ to output a valid "RFC822" pubDate string. This is required for a [valid RSS string](http://www.w3.org/Protocols/rfc822/#z28) and can be interpreted by PHP easily. There are also smaller functions available to convert dates and times to friendly formats, _ou:displayLongDate()_, _ou:dayOfWeekAbbrevEn()_, etc.

### PHP

#### blog-functions.php
Takes parameters from listing.php to crawl defined directories and extracts data from posts XMLs. Builds _blogFile Class_, handles _conditions[]_ sent by listing.php, sorts whether is needs to be displayed, converts everything to JSON and passes it back to the display functions in listing.php. Also contains misc. functions, and the _Asset Listing_ functions, "Recent Posts", "Posts Tags", etc.

#### listing.php
Takes parameters from the listing template page, queries blog-functions.php, converts JSON, echo's out main listing _displayBlogPost()_, and featured slideshow _displayFeaturedSlides()_.

#### rss.php
Output a valid RSS feed based of URL parameters. By default this code will return all blog posts. Valid URL params:

 * "dir" - The directory where the script should begin crawling for post files, defaults to blog root.
 * "limit" - Maximum number of posts returned, default "" returns all.
 * "tags" - Only return posts from specific tags, default "" no categorization.
 * "featured" - "true" to return only featured posts, default "false".
 * "year" - return posts from a specific year, default "" return all years.